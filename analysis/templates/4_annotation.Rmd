---
title: "Cell type annotation"
params:
  seed: 42
  input_file: "../results/SCE/merged.sce"
  output_file: "annotated.sce"
  process_fun: "../bin/process_sce.R"
---

```{r setup}
seed <- params$seed
set.seed(seed)

# Load the libraries
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(Seurat)
  library(scater)
  library(scran)
  library(tricycle)
  library(SingleR)
  library(celldex)
  library(tidyverse)
  library(patchwork)
  library(ggridges)
})

path_sce_input <- params$input_file
path_sce_output <- params$output_file

process_fun <- params$process_fun
source(process_fun)
```

# Read the sce

```{r load_sce}
sce <- readRDS(path_sce_input)
sce
```

```{r}
colData(sce) %>% 
  as.data.frame() %>% 
  group_by(Sample) %>% 
  reframe(cells = n())
```

```{r, fig.width=10, fig.height=7.5}
plotColData(sce, y = "sum",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_blank()) +
  labs(y = "UMIs per cell, log10") + 
  
  plotColData(sce, y = "detected",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text.x = element_blank()) +
  labs(y = "nGenes per cell, log10") +
  
  plotColData(sce, y = "Mito_Ribo_Ratio",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "pseudo_log") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "%Mito/%Ribo ratio, log10") +
  
  plot_layout(ncol = 1)
```

# Process all cells

```{r process_sce}
sce <- process_sce(
  sce, 
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  seed = seed,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.5, 0.6),
  return_obj = "sce"
)
```

## Choose cluster resolution

```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```

```{r, fig.width=10, fig.height=5}
plotUMAP(sce,
         color_by = "MS4A1") +
  plotUMAP(sce,
         color_by = "CCND1")
```

```{r UMAP_clusters, fig.width=8, fig.height=7}
sce[["clusters"]] <- sce[["clusters_res_0.3"]]
plotUMAP(sce,
         color_by = "clusters",
         text_by = "clusters")
```

# Inspect cells by sample

```{r, fig.width=6, fig.height=5}
plotUMAP(sce,
         color_by = "Sample")
```

```{r, fig.width=10.5, fig.height=5}
plotUMAP(sce,
         color_by = "Patient",
         other_fields = "Timepoint") +
  facet_wrap(~ Timepoint) +
  theme_bw()
```

```{r, fig.width=10, fig.height=10}
plotUMAP(sce,
         color_by = "Sample", other_fields = "Sample") +
  facet_wrap(
    ~ Sample
  )
```

```{r, fig.width=10, fig.height=10}
plotUMAP(sce,
         color_by = "IGKC", other_fields = "Sample") +
  facet_wrap(
    ~ Sample
  )
```

## Cell cycle scoring

If cell cycle effects are not addressed, later when annotating the normal cells, cycling T cells would form a cluster.
Tested that even if they are regressed the cluster still forms.

```{r project_cycle_space, fig.width=7, fig.height=5}
sce <- project_cycle_space(sce,
                           species = "human",
                           gname.type = "SYMBOL")

center_PCs <- c(-3, 0.4)

sce <- estimate_cycle_position(sce,
                               center.pc1 = center_PCs[1],
                               center.pc2 = center_PCs[2])

p <- plot_emb_circle_scale(sce,
                           dimred = "tricycleEmbedding",
                           point.size = 3.5,
                           point.alpha = 0.9) +
  annotate(
    "point",
    x = center_PCs[1],
    y = center_PCs[2],
    size = 4,
    color = "red",
    shape = 8,
    stroke = 1
  ) +
  labs(title = NULL) +
  theme_bw(base_size = 14)
legend <- circle_scale_legend(text.size = 4.5, alpha = 0.9)
cowplot::plot_grid(p, legend, ncol = 2, rel_widths = c(1, 0.4))
```

```{r tricycle_phases, fig.width=6, fig.height=5}
phases = c(
  "G1" = 0.2 * pi,
  "S" = 0.8 * pi,
  "G2.M" = 1 * pi,
  "G0" = 1.8 * pi
)

# Map position to phase
TCP.df <- data.frame(colname = colnames(sce),
                     TCP = sce$tricyclePosition,
                     Phase = NA
                     )
for(position in names(phases)){
  TCP.df[TCP.df$TCP > phases[[position]] ,]$Phase <- position
}
TCP.df[is.na(TCP.df$Phase), ]$Phase <- "G0"
TCP.df$Phase <- factor(TCP.df$Phase,
                       levels = c("G0", "G1", "S", "G2.M") )

sce$tricyclePhase <- TCP.df$Phase

ggcells(sce,
        mapping = aes(x = tricycleEmbedding.1,
                      y = tricycleEmbedding.2
                      )
        ) +
  geom_point(
    aes(color = tricyclePhase)
  ) +
  geom_density2d(
    data = as.data.frame(reducedDims(sce)[["tricycleEmbedding"]]),
    aes(x = PC1, y = PC2), adjust = 2,
    color = "black"
  ) +
  annotate("point",
           x = center_PCs[1],
           y = center_PCs[2],
           size = 4,
           color = "black", shape = 4,
           stroke = 1
           )
```

```{r, fig.width=6, fig.height=5}
plotUMAP(sce,
         color_by = "tricyclePhase")
```

## Automatic cell types

```{r cache_reference}
gypsum::cacheDirectory("./gypsum_cache")
ref <- celldex::MonacoImmuneData()
ref
```

```{r reference_based_annotation, warning=FALSE, fig.width=6, fig.height=5}
predicted.types.main <- SingleR(
  test = sce,
  ref = ref,
  labels = ref$label.main,
  de.method = "classic"
)

# assign cell types to sce
sce$cell_type_main <- predicted.types.main$labels

colData(sce) %>% 
  as.data.frame() %>% 
  group_by(cell_type_main) %>% 
  reframe(N = n()) %>% 
  arrange(desc(N))
```

```{r, fig.width=8, fig.height=7}
plotUMAP(sce,
         color_by = "cell_type_main") +
  labs(title = "Cell types")
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce,
         color_by = "cell_type_main",
         other_fields = c("Patient", "Timepoint")) +
  facet_grid(Timepoint ~ Patient) +
  theme_bw() +
  labs(title = "Cell types")
```

## B cell clusters

```{r, fig.width=10, fig.height=9}
plotUMAP(sce, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  plotUMAP(sce, color_by = "cell_type_main") +
  labs(title = "Cell types") +
  plotUMAP(sce, color_by = "MS4A1") +
  labs(title = "CD20 - B cells") +
  plotUMAP(sce, color_by = "CCND1") +
  labs(title = "Cyclin D1")
```

## Label cell clusters

```{r}
cell_type_df <- colData(sce) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters %in% c(16, 17) ~ "Other",
      clusters %in% c(2, 6, 12, 13) ~ "T cell",
      TRUE ~ "B cell",
    )
  )

cluster_to_celltype <- setNames(cell_type_df$cell_type, cell_type_df$clusters)
colData(sce)$cell_type_manual <- cluster_to_celltype[as.character(colData(sce)$clusters)]

data.frame(
  cell_type_manual = sce$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r, fig.width=5.5, fig.height=5}
plotUMAP(sce, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation 1")
```

# Re-cluster B cells

```{r process_sce_B_cells, fig.height=6, fig.width=10}
sce_B <- sce[, sce$cell_type_manual == "B cell"]

cluster_cols <- grep("^clusters_res", colnames(sce_B@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_B[[cluster_col]] <- NULL
}

sce_B <- process_sce(
  sce_B,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.5, 0.6),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B, color_by = "Sample") +
  theme(legend.position = "bottom") +

plotUMAP(sce_B, color_by = "CCND1") +
  theme(legend.position = "bottom") +
  labs(title = "Cyclin D1") +
  
  plotUMAP(sce_B, color_by = "tricyclePhase") +
  theme(legend.position = "bottom")
```


```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce_B@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_B, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```

```{r, fig.width=15, fig.height=6}
sce_B[["clusters"]] <- sce_B[["clusters_res_0.1"]]

plotUMAP(sce_B, color_by = "Sample") +
  theme(legend.position = "bottom") +
  labs(title = "Sample") +
  plotUMAP(sce_B, color_by = "clusters", text_by = "clusters") +
  theme(legend.position = "bottom") +
  labs(title = "Clusters") +
  plotUMAP(sce_B, color_by = "CCND1") +
  theme(legend.position = "bottom") +
  labs(title = "Cyclin D1")
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B, color_by = "IGLC1") +
  theme(legend.position = "bottom") +
  
  plotUMAP(sce_B, color_by = "IGLC2") +
  theme(legend.position = "bottom") +
  
  plotUMAP(sce_B, color_by = "IGKC") +
  theme(legend.position = "bottom")
```


```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B,
         color_by = "clusters",
         other_fields = c("Patient", "Timepoint")) +
  facet_grid(Timepoint ~ Patient) +
  theme_bw()
```

```{r}
B_cells_df <- colData(sce_B) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters %in% c(3) ~ "B cell",
      TRUE ~ "MCL cell"
    )
  )

cluster_to_Bcell <- setNames(B_cells_df$cell_type, B_cells_df$clusters)
colData(sce_B)$cell_type_manual <- cluster_to_Bcell[as.character(colData(sce_B)$clusters)]

data.frame(
  cell_type_manual = sce_B$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r, fig.width=8, fig.height=7}
plotUMAP(sce_B, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation for B cells")
```

## Inspect CCND1 threshold

```{r, fig.height=4, fig.width=10}
cell.types <- c("MCL cell", "B cell")

CCND1_logcount_threshold <- 0.5

cell.types <- c("B cell", "MCL cell")

CCND1_logcount_threshold <- 0.25

data.frame(
  Patient = sce_B$Patient,
  Cell_type = sce_B$cell_type_manual,
  "logcounts.CCND1" = logcounts(sce_B)["CCND1", ]
) %>%
  mutate(Cell_type = factor(Cell_type, levels = cell.types)) %>%
  ggplot() +
  geom_histogram(
    aes(x = logcounts.CCND1, fill = Cell_type),
    bins = 50
    ) +
  geom_vline(xintercept = CCND1_logcount_threshold,
             color = "grey10", linetype = "dashed"
             ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  
  
  facet_grid(~ Cell_type) +
  labs(y = "Cells", x = "log(counts) CCND1") +
  theme_bw()
```

This shows why just setting an expression threshold does not work:

```{r fig.width=8, fig.height=8}
colData(sce_B)$CCND1_status <- ifelse(logcounts(sce_B)["CCND1", ] > CCND1_logcount_threshold,
                                    "CCND1_high",
                                    "CCND1_low")

plotUMAP(sce_B, color_by = "CCND1_status")
```

```{r fig.height=4, fig.width=10}
data.frame(
  Patient = sce_B$Patient,
  CCND1_status = sce_B$CCND1_status,
  "logcounts.CCND1" = logcounts(sce_B)["CCND1", ]
) %>%
  mutate(Cell_type = factor(CCND1_status, levels = c("CCND1_low", "CCND1_high"))) %>%
  ggplot() +
  geom_histogram(
    aes(x = logcounts.CCND1, fill = Cell_type),
    bins = 50
    ) +
  geom_vline(xintercept = CCND1_logcount_threshold,
             color = "grey10", linetype = "dashed"
             ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  
  facet_grid(~ Cell_type) +
  labs(y = "Cells", x = "log(counts) CCND1") +
  theme_bw()
```

```{r}
Bcell_types <- colData(sce_B) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "Bcell_type" = "cell_type_manual")

all_cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., Bcell_types, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type_manual = case_when(
      cell_type_manual == "B cell" ~ Bcell_type,
      TRUE ~ cell_type_manual
    ),
    Bcell_type = NULL
  )

sce$cell_type_manual <- all_cell_types$cell_type_manual
```

```{r fig.width=8, fig.height=7}
plotUMAP(sce, color_by = "cell_type_manual") +
  labs(title = "Manual annotation 2")
```

# Re-cluster T cells

```{r, fig.height=6, fig.width=10}
sce_T <- sce[, sce$cell_type_manual == "T cell"]

# Remove T cells with IgG contamination
IGKC_logcount_thresh <- 0.5

IgG_logcounts <- logcounts(sce_T["IGKC", ])[1, ]
IgG_logcounts <- data.frame(
  Sample_Barcode = names(IgG_logcounts),
  IgG_logcount = unname(IgG_logcounts)
)

sce_T$contaminated_Tcell <- left_join(
    as.data.frame(colData(sce_T)),
    IgG_logcounts,
    by = join_by("Sample_Barcode")
  ) %>% 
  mutate(
    contaminated_Tcell = case_when(
      IgG_logcount > IGKC_logcount_thresh ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>% 
  pull(contaminated_Tcell)

sce_T$IgG_logcounts <- logcounts(sce_T["IGKC", ])[1, colnames(sce_T)]

sce_T
```

```{r fig.width=8, fig.height=7}
plotUMAP(sce_T, color_by = "contaminated_Tcell")
```

```{r}
plotColData(
  sce_T,
  y = "contamination",
  x = "IgG_logcounts",
  color_by = "contaminated_Tcell"
) +
  scale_x_continuous(
    #trans = "pseudo_log",
    breaks = c(0, 0.5, 1, 2, 10, 30)) +
  geom_vline(xintercept = IGKC_logcount_thresh)
```

```{r}
colData(sce_T) %>%
  as.data.frame() %>%
  group_by(Compartment, contaminated_Tcell) %>%
  reframe(cells = n()) %>%
  pivot_wider(
    names_from = contaminated_Tcell,
    values_from = cells,
    names_prefix = "contaminated_",
    values_fill = 0
  )
```


```{r, fig.height=6, fig.width=10}
cluster_cols <- grep("^clusters_res", colnames(sce_T@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_T[[cluster_col]] <- NULL
}

sce_T <- sce_T[, sce_T$]

sce_T <- process_sce(
  sce_T,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  vars_to_regress = "IgG_logcount",
  pca_variance_threshold = 1.5,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.45, 0.5),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=9, fig.height=8}
plotUMAP(sce_T, color_by = "CD3D") + labs(title = "CD3 Delta - T cells") +

plotUMAP(sce_T, color_by = "CD8A") + labs(title = "CD8+ T cells") +

plotUMAP(sce_T, color_by = "CD4") + labs(title = "CD4+ T cells") +

plotUMAP(sce_T, color_by = "NCR1") + labs(title = "MCR1 - NK cells")
```

```{r, fig.width=10, fig.height=4.5}
plotUMAP(sce_T, color_by = "IGKC") +
  plotUMAP(sce_T, color_by = "IGHM")
```

```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce_T@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_T, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```


```{r, fig.width=11, fig.height=7}
sce_T[["clusters"]] <- sce_T[["clusters_res_0.2"]]
plotUMAP(
    sce_T,
    color_by = "clusters",
    other_fields = "Compartment"
    ) +
  theme_bw() +
  facet_wrap(~ Compartment)
```

```{r}
colData(sce_T) %>% 
  as.data.frame() %>% 
  group_by(Compartment, clusters) %>% 
  reframe(cells = n()) %>% 
  pivot_wider(
    names_from = "Compartment", values_from = "cells", values_fill = 0
  ) %>% 
  arrange(clusters)
```

```{r, fig.width=12, fig.height=10}
plotUMAP(sce_T, color_by = "Sample") +
  labs(title = "Sample") +
  
  plotUMAP(sce_T, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  
  plotUMAP(sce_T, color_by = "cell_type_main") +
  labs(title = "SingleR cell types") +
  
  plotUMAP(sce_T, color_by = "tricyclePhase") +
  labs(title = "Cell cycle")
```

## Analyze markers

```{r, warning=FALSE}
rowData(sce_T)[["Unique_Symbol"]] <- make.unique(rowData(sce_T)[["Symbol"]])
rownames(sce_T) <- rowData(sce_T)[["Unique_Symbol"]]
seurat_T <- as.Seurat(sce_T, counts = "counts", data = "logcounts")

Idents(seurat_T) <- seurat_T$clusters

T_cell_clusters = levels(seurat_T$clusters)
  
markers_list <- list()
for(cluster in T_cell_clusters){
  markers <- FindMarkers(seurat_T, ident.1 = cluster,
                         test.use = "wilcox",
                         logfc.threshold = 0.5,
                         min.pct = 0.1,
                         only.pos = TRUE,
                         random.seed = seed
                         )
  markers_text <- head(markers, n = 60) %>% 
    rownames() %>% 
    paste(collapse = ", ")
  markers_text <- paste0("Cluster ", cluster, ": ", markers_text)
  markers_list[[as.character(cluster)]] <- markers_text
}
text <- paste(markers_list, collapse = "\n\n")
cat(text)
```

```{r}
cells_df <- colData(sce_T) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters == 1 ~ "T cells CD4+",
      clusters == 2 ~ "T cells CD8+ Effector/Memory",
      clusters == 3 ~ "T cells CD8+ Effector/Cytotoxic",
      clusters == 4 ~ "T cells CD8+ Exhausted",
      clusters == 5 ~ "NK cells",
      clusters == 6 ~ "T cells γδ",
      clusters == 7 ~ "",
    )
  )

cluster_to_cells <- setNames(cells_df$cell_type, cells_df$clusters)
colData(sce_T)$cell_type_manual <- cluster_to_cells[as.character(colData(sce_T)$clusters)]

data.frame(
  cell_type_manual = sce_T$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r fig.width=9, fig.height=7}
plotUMAP(sce_T, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation")
```

```{r fig.width=9, fig.height=7}
cell_type <- colData(sce_T) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type" = "cell_type_manual")

all_cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., cell_type, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type_manual = case_when(
      cell_type_manual == "T cell" ~ cell_type,
      TRUE ~ cell_type_manual
    ),
    cell_type = NULL
  )

sce$cell_type_manual <- all_cell_types$cell_type_manual

plotUMAP(sce, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation")
```

# Re-cluster B and other normal cells

```{r, fig.height=6, fig.width=10}
sce_n <- sce[, sce$cell_type_manual %in% c("B cell", "Other")]

cluster_cols <- grep("^clusters_res", colnames(sce_n@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_n[[cluster_col]] <- NULL
}

sce_n <- process_sce(
  sce_n,
  vars_to_regress = "tricyclePhase",
  RunPCA_npcs = 30,
  pca_variance_threshold = 2.5,
  FindNeighbors_knn = 20,
  FindClusters_res = c(0.1, 0.2, 0.5),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=10, fig.height=4.5}
plotUMAP(sce_n, color_by = "MS4A1") +
  plotUMAP(sce_n, color_by = "IGHM")
```


```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce_n@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_n, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```

```{r, fig.width=11, fig.height=7}
sce_n[["clusters"]] <- sce_n[["clusters_res_0.5"]]
plotUMAP(
    sce_n,
    color_by = "clusters",
    other_fields = "Compartment"
    ) +
  theme_bw() +
  facet_wrap(~ Compartment)
```

```{r UMAPs_leukocytes, fig.width=12, fig.height=10}
plotUMAP(sce_n, color_by = "Sample") +
  labs(title = "Sample") +
  
  plotUMAP(sce_n, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  
  plotUMAP(sce_n, color_by = "cell_type_main") +
  labs(title = "SingleR cell types") +
  
  plotUMAP(sce_n, color_by = "tricyclePhase") +
  labs(title = "Cell cycle")
```

```{r featureUMAP_leukocytes, fig.width=8, fig.height=4}
plotUMAP(sce_n, color_by = "FCGR3A") + labs(title = "CD16a - Monocytes") +

plotUMAP(sce_n, color_by = "LYZ") + labs(title = "LYZ - Monocytes")
```

## Analyze markers

```{r, warning=FALSE}
rowData(sce_n)[["Unique_Symbol"]] <- make.unique(rowData(sce_n)[["Symbol"]])
rownames(sce_n) <- rowData(sce_n)[["Unique_Symbol"]]
seurat_n <- as.Seurat(sce_n, counts = "counts", data = "logcounts")

Idents(seurat_n) <- seurat_n$clusters

clusters <- levels(Idents(seurat_n))

markers_list <- list()
for(cluster in clusters){
  markers <- FindMarkers(seurat_n, ident.1 = cluster,
                         test.use = "wilcox",
                         logfc.threshold = 0.5,
                         min.pct = 0.1,
                         only.pos = TRUE)
  markers_text <- head(markers, n = 50) %>% 
    rownames() %>% 
    paste(collapse = ", ")
  markers_text <- paste0("Cluster ", cluster, ": ", markers_text)
  markers_list[[as.character(cluster)]] <- markers_text
}
text <- paste(markers_list, collapse = "\n\n")
cat(text)
```

Cluster 1: Memory B cells

The high expression of MS4A1 (CD20), immunoglobulin genes (IGKC, IGHG1, IGHG3), and class II MHC molecules (HLA-DRA, HLA-DRB1, etc.) indicates B cells. The presence of IGHG class-switched immunoglobulins, CD27, and B cell receptors (FCRLs) suggests these are memory B cells. CD72, BANK1, and CD22 further support the B cell identity.

Cluster 2: Naive B cells

This cluster shows high expression of ribosomal proteins (RPL/RPS series) indicating active protein synthesis. The B cell markers MS4A1 (CD20), CD79B, IGHM, and FCMR suggest naive B cells. The IGHM (IgM) expression without significant class-switched immunoglobulins supports this annotation.

Cluster 3: IgA-secreting Plasma cells/Plasmablasts

The high expression of IGHA1, IGHA2 (IgA heavy chains) and JCHAIN is characteristic of plasma cells. The expression of TNFRSF13B (TACI) and TNFRSF13C (BAFF-R) is consistent with terminally differentiated B cells. These appear to be IgA-secreting plasma cells or plasmablasts.

Cluster 4: Non-classical Monocytes (CD16+)

This cluster expresses myeloid markers including FCGR3A (CD16), FCER1G, AIF1, TYROBP, CSF1R, LILRB2, CD68, and CLEC7A. The presence of CD16 (FCGR3A) without strong CD14 expression indicates these are non-classical monocytes.

Cluster 5: Classical Monocytes (CD14+)

The expression of CD14, LYZ, S100A8, S100A9, VCAN, and FCN1 is characteristic of classical monocytes. The high levels of S100A8/A9 (calprotectin), CST3, and CTSD further support this annotation.

Cluster 6: Pre-B cells/Immature B cells

The expression of VPREB1, VPREB3, RAG1, and CD38 are hallmarks of early B cell development. The presence of MME (CD10) and TCL1A is consistent with pre-B or immature B cells. IRF4 suggests these cells may be transitioning to the next stage of development.

Cluster 7: Transitional/Naive B cells

This cluster shows markers of maturing B cells including IGHD (IgD), FCER2 (CD23), CD40, and SELL (CD62L). The expression of CCR7 and CXCR4 indicates these are likely transitional B cells moving toward a naive B cell phenotype.

Cluster 8: Proliferating cells

This cluster is characterized by cell cycle and proliferation markers including MKI67 (Ki-67), TOP2A, TYMS, CDK1, cyclins (CCNA2, CCNB2), and mitotic spindle proteins. These are actively dividing cells, likely proliferating B cells based on your sample description.

Cluster 9: Erythroid cells

The expression of hemoglobin genes (HBD, HBA1), erythroid transcription factors (GATA1, TAL1, KLF1), and erythrocyte membrane proteins (GYPA, GYPB, EPB42) clearly identifies these as erythroid lineage cells. The presence of KIT (CD117) suggests they include erythroid progenitors.

```{r}
N_cells_df <- colData(sce_n) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters == 1 ~ "B cell Memory",
      clusters == 2 ~ "B cell Naive",
      clusters == 3 ~ "Plasma cells",
      clusters == 4 ~ "Monocytes Non-classical",
      clusters == 5 ~ "Monocytes Classical",
      clusters == 6 ~ "Pre-B cells",
      clusters == 7 ~ "B cells Transitional/Naive",
      clusters == 8 ~ "B cells Cycling",
      clusters == 9 ~ "Erythroid progenitors"
    )
  )

cluster_to_cells <- setNames(N_cells_df$cell_type, N_cells_df$clusters)
colData(sce_n)$cell_type_manual <- cluster_to_cells[as.character(colData(sce_n)$clusters)]

data.frame(
  cell_type_manual = sce_n$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r UMAP_leukocyte_types, fig.width=9, fig.height=7}
plotUMAP(sce_n, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation")
```

```{r}
cell_type <- colData(sce_n) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type" = "cell_type_manual")

all_cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., cell_type, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type_manual = case_when(
      cell_type_manual %in% c("Other", "B cell") ~ cell_type,
      TRUE ~ cell_type_manual
    ),
    cell_type = NULL
  )

sce$cell_type_manual <- all_cell_types$cell_type_manual
```

```{r UMAP_cell_types, fig.width=8, fig.height=7}
plotUMAP(sce, color_by = "cell_type_manual") +
  labs(title = "Cell type annotation")
```

# Save results

```{r write_sce}
saveRDS(sce, path_sce_output)
```

# Session info

```{r sessionInfo}
print(sessionInfo())
```

```{r gc}
gc()
```
