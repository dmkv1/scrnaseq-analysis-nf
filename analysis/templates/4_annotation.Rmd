---
title: "Cell type annotation"
params:
  seed: 42
  input_file: "../results/SCE/merged.sce"
  output_file: "annotated.sce"
  process_fun: "../bin/process_sce.R"
---

```{r setup}
seed <- params$seed
set.seed(seed)

# Load the libraries
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(Seurat)
  library(scater)
  library(scran)
  library(tricycle)
  library(SingleR)
  library(celldex)
  library(tidyverse)
  library(patchwork)
  library(ggridges)
})

path_sce_input <- params$input_file
path_sce_output <- params$output_file

process_fun <- params$process_fun
source(process_fun)

# Product-Based Ranking with Normalization 
rank_genes_enhanced <- function(markers) {
  # In case any p value is 0
  min_nonzero_p <- min(markers$p_val_adj[markers$p_val_adj > 0])
  markers$p_val_adj[markers$p_val_adj == 0] <- min_nonzero_p / 10
  
  # Normalize components to 0-1 scale
  norm_pval <- (-log10(markers$p_val_adj) - min(-log10(markers$p_val_adj))) /
    (max(-log10(markers$p_val_adj)) - min(-log10(markers$p_val_adj)))
  
  norm_fc <- (markers$avg_log2FC - min(markers$avg_log2FC)) /
    (max(markers$avg_log2FC) - min(markers$avg_log2FC))
  
  # Product-based score
  markers$rank_score <- norm_pval * norm_fc
  
  # Sort and return
  return(markers[order(markers$rank_score, decreasing = TRUE), ])
}
```

# Read the sce

```{r load_sce}
sce <- readRDS(path_sce_input)
sce
```

```{r}
colData(sce) %>% 
  as.data.frame() %>% 
  group_by(Sample) %>% 
  reframe(cells = n())
```

```{r, fig.width=10, fig.height=7.5}
plotColData(sce, y = "sum",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_blank()) +
  labs(y = "UMIs per cell, log10") + 
  
  plotColData(sce, y = "detected",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text.x = element_blank()) +
  labs(y = "nGenes per cell, log10") +
  
  plotColData(sce, y = "Mito_Ribo_Ratio",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "pseudo_log") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "%Mito/%Ribo ratio, log10") +
  
  plot_layout(ncol = 1)
```

# Process all cells

```{r process_sce}
sce <- process_sce(
  sce, 
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  seed = seed,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.5, 0.6),
  return_obj = "sce"
)
```

## Choose cluster resolution

```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```

```{r, fig.width=10, fig.height=5}
plotUMAP(sce,
         color_by = "MS4A1") +
  plotUMAP(sce,
         color_by = "CCND1")
```

```{r UMAP_clusters, fig.width=8, fig.height=7}
sce[["clusters"]] <- sce[["clusters_res_0.3"]]
plotUMAP(sce,
         color_by = "clusters",
         text_by = "clusters")
```

# Inspect cells by sample

```{r, fig.width=6, fig.height=5}
plotUMAP(sce,
         color_by = "Sample")
```

```{r, fig.width=10.5, fig.height=5}
plotUMAP(sce,
         color_by = "Patient",
         other_fields = "Timepoint") +
  facet_wrap(~ Timepoint) +
  theme_bw()
```

```{r, fig.width=10, fig.height=10}
plotUMAP(sce,
         color_by = "Sample", other_fields = "Sample") +
  facet_wrap(
    ~ Sample
  )
```

```{r, fig.width=10, fig.height=10}
plotUMAP(sce,
         color_by = "IGKC", other_fields = "Sample") +
  facet_wrap(
    ~ Sample
  )
```

## Cell cycle scoring

If cell cycle effects are not addressed, later when annotating the normal cells, cycling T cells would form a cluster.
Tested that even if they are regressed the cluster still forms.

```{r project_cycle_space, fig.width=7, fig.height=5}
sce <- project_cycle_space(sce,
                           species = "human",
                           gname.type = "SYMBOL")

center_PCs <- c(-3, 0.4)

sce <- estimate_cycle_position(sce,
                               center.pc1 = center_PCs[1],
                               center.pc2 = center_PCs[2])

p <- plot_emb_circle_scale(sce,
                           dimred = "tricycleEmbedding",
                           point.size = 3.5,
                           point.alpha = 0.9) +
  annotate(
    "point",
    x = center_PCs[1],
    y = center_PCs[2],
    size = 4,
    color = "red",
    shape = 8,
    stroke = 1
  ) +
  labs(title = NULL) +
  theme_bw(base_size = 14)
legend <- circle_scale_legend(text.size = 4.5, alpha = 0.9)
cowplot::plot_grid(p, legend, ncol = 2, rel_widths = c(1, 0.4))
```

```{r tricycle_phases, fig.width=6, fig.height=5}
phases = c(
  "G1" = 0.2 * pi,
  "S" = 0.8 * pi,
  "G2.M" = 1 * pi,
  "G0" = 1.8 * pi
)

# Map position to phase
TCP.df <- data.frame(colname = colnames(sce),
                     TCP = sce$tricyclePosition,
                     Phase = NA
                     )
for(position in names(phases)){
  TCP.df[TCP.df$TCP > phases[[position]] ,]$Phase <- position
}
TCP.df[is.na(TCP.df$Phase), ]$Phase <- "G0"
TCP.df$Phase <- factor(TCP.df$Phase,
                       levels = c("G0", "G1", "S", "G2.M") )

sce$tricyclePhase <- TCP.df$Phase

ggcells(sce,
        mapping = aes(x = tricycleEmbedding.1,
                      y = tricycleEmbedding.2
                      )
        ) +
  geom_point(
    aes(color = tricyclePhase)
  ) +
  geom_density2d(
    data = as.data.frame(reducedDims(sce)[["tricycleEmbedding"]]),
    aes(x = PC1, y = PC2), adjust = 2,
    color = "black"
  ) +
  annotate("point",
           x = center_PCs[1],
           y = center_PCs[2],
           size = 4,
           color = "black", shape = 4,
           stroke = 1
           )
```

```{r, fig.width=6, fig.height=5}
plotUMAP(sce,
         color_by = "tricyclePhase")
```

## Automatic cell types

```{r cache_reference}
gypsum::cacheDirectory("./gypsum_cache")
ref <- celldex::MonacoImmuneData()
ref
```

```{r reference_based_annotation, warning=FALSE, fig.width=6, fig.height=5}
predicted.types.main <- SingleR(
  test = sce,
  ref = ref,
  labels = ref$label.main,
  de.method = "classic"
)

# assign cell types to sce
sce$cell_type_main <- predicted.types.main$labels

colData(sce) %>% 
  as.data.frame() %>% 
  group_by(cell_type_main) %>% 
  reframe(N = n()) %>% 
  arrange(desc(N))
```

```{r, fig.width=8, fig.height=7}
plotUMAP(sce,
         color_by = "cell_type_main") +
  labs(title = "Cell types")
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce,
         color_by = "cell_type_main",
         other_fields = c("Patient", "Timepoint")) +
  facet_grid(Timepoint ~ Patient) +
  theme_bw() +
  labs(title = "Cell types")
```

## B cell clusters

```{r, fig.width=10, fig.height=9}
plotUMAP(sce, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  plotUMAP(sce, color_by = "cell_type_main") +
  labs(title = "Cell types") +
  plotUMAP(sce, color_by = "MS4A1") +
  labs(title = "CD20 - B cells") +
  plotUMAP(sce, color_by = "CCND1") +
  labs(title = "Cyclin D1")
```

## Label cell clusters

```{r}
cell_type_df <- colData(sce) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters %in% c(16, 17) ~ "Other",
      clusters %in% c(2, 6, 12, 13) ~ "T cell",
      TRUE ~ "B cell",
    )
  )

cluster_to_celltype <- setNames(cell_type_df$cell_type, cell_type_df$clusters)
sce$cell_type_manual <- cluster_to_celltype[as.character(colData(sce)$clusters)]

data.frame(
  cell_type_manual = sce$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r, fig.width=5.5, fig.height=5}
plotUMAP(sce, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation 1")
```

# Re-cluster B cells

```{r process_sce_B_cells, fig.height=6, fig.width=10}
sce_B <- sce[, sce$cell_type_manual == "B cell"]

cluster_cols <- grep("^clusters_res", colnames(sce_B@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_B[[cluster_col]] <- NULL
}

sce_B <- process_sce(
  sce_B,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.5, 0.6),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B, color_by = "Sample") +
  theme(legend.position = "bottom") +

plotUMAP(sce_B, color_by = "CCND1") +
  theme(legend.position = "bottom") +
  labs(title = "Cyclin D1") +
  
  plotUMAP(sce_B, color_by = "tricyclePhase") +
  theme(legend.position = "bottom")
```


```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce_B@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_B, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```

```{r, fig.width=15, fig.height=6}
sce_B[["clusters"]] <- sce_B[["clusters_res_0.1"]]

plotUMAP(sce_B, color_by = "Sample") +
  theme(legend.position = "bottom") +
  labs(title = "Sample") +
  plotUMAP(sce_B, color_by = "clusters", text_by = "clusters") +
  theme(legend.position = "bottom") +
  labs(title = "Clusters") +
  plotUMAP(sce_B, color_by = "CCND1") +
  theme(legend.position = "bottom") +
  labs(title = "Cyclin D1")
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B, color_by = "IGLC1") +
  theme(legend.position = "bottom") +
  
  plotUMAP(sce_B, color_by = "IGLC2") +
  theme(legend.position = "bottom") +
  
  plotUMAP(sce_B, color_by = "IGKC") +
  theme(legend.position = "bottom")
```


```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B,
         color_by = "clusters",
         other_fields = c("Patient", "Timepoint")) +
  facet_grid(Timepoint ~ Patient) +
  theme_bw()
```

```{r}
B_cells_df <- colData(sce_B) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters %in% c(3) ~ "B cell",
      TRUE ~ "MCL cell"
    )
  )

cluster_to_Bcell <- setNames(B_cells_df$cell_type, B_cells_df$clusters)
colData(sce_B)$cell_type_manual <- cluster_to_Bcell[as.character(colData(sce_B)$clusters)]

data.frame(
  cell_type_manual = sce_B$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r, fig.width=8, fig.height=7}
plotUMAP(sce_B, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation for B cells")
```

## Inspect CCND1 threshold

```{r, fig.height=4, fig.width=10}
cell.types <- c("MCL cell", "B cell")

CCND1_logcount_threshold <- 0.5

cell.types <- c("B cell", "MCL cell")

CCND1_logcount_threshold <- 0.25

data.frame(
  Patient = sce_B$Patient,
  Cell_type = sce_B$cell_type_manual,
  "logcounts.CCND1" = logcounts(sce_B)["CCND1", ]
) %>%
  mutate(Cell_type = factor(Cell_type, levels = cell.types)) %>%
  ggplot() +
  geom_histogram(
    aes(x = logcounts.CCND1, fill = Cell_type),
    bins = 50
    ) +
  geom_vline(xintercept = CCND1_logcount_threshold,
             color = "grey10", linetype = "dashed"
             ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  
  
  facet_grid(~ Cell_type) +
  labs(y = "Cells", x = "log(counts) CCND1") +
  theme_bw()
```

This shows why just setting an expression threshold does not work:

```{r fig.width=8, fig.height=8}
colData(sce_B)$CCND1_status <- ifelse(logcounts(sce_B)["CCND1", ] > CCND1_logcount_threshold,
                                    "CCND1_high",
                                    "CCND1_low")

plotUMAP(sce_B, color_by = "CCND1_status")
```

```{r fig.height=4, fig.width=10}
data.frame(
  Patient = sce_B$Patient,
  CCND1_status = sce_B$CCND1_status,
  "logcounts.CCND1" = logcounts(sce_B)["CCND1", ]
) %>%
  mutate(Cell_type = factor(CCND1_status, levels = c("CCND1_low", "CCND1_high"))) %>%
  ggplot() +
  geom_histogram(
    aes(x = logcounts.CCND1, fill = Cell_type),
    bins = 50
    ) +
  geom_vline(xintercept = CCND1_logcount_threshold,
             color = "grey10", linetype = "dashed"
             ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  
  facet_grid(~ Cell_type) +
  labs(y = "Cells", x = "log(counts) CCND1") +
  theme_bw()
```

```{r}
Bcell_types <- colData(sce_B) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "Bcell_type" = "cell_type_manual")

all_cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., Bcell_types, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type_manual = case_when(
      cell_type_manual == "B cell" ~ Bcell_type,
      TRUE ~ cell_type_manual
    ),
    Bcell_type = NULL
  )

sce$cell_type_manual <- all_cell_types$cell_type_manual
```

```{r fig.width=8, fig.height=7}
plotUMAP(sce, color_by = "cell_type_manual") +
  labs(title = "Manual annotation 2")
```

# Re-cluster T cells

```{r, fig.height=6, fig.width=10}
sce_T <- sce[, sce$cell_type_manual == "T cell"]

# Remove T cells with IgG contamination
IGKC_logcount_thresh <- 0.5

IgG_logcounts <- logcounts(sce_T["IGKC", ])[1, ]
IgG_logcounts <- data.frame(
  Sample_Barcode = names(IgG_logcounts),
  IgG_logcount = unname(IgG_logcounts)
)

sce_T$contaminated_Tcell <- left_join(
    as.data.frame(colData(sce_T)),
    IgG_logcounts,
    by = join_by("Sample_Barcode")
  ) %>% 
  mutate(
    contaminated_Tcell = case_when(
      IgG_logcount > IGKC_logcount_thresh ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>% 
  pull(contaminated_Tcell)

sce_T$IgG_logcounts <- logcounts(sce_T["IGKC", ])[1, colnames(sce_T)]
sce_T$IgG_counts <- counts(sce_T["IGKC", ])[1, colnames(sce_T)]

sce_T
```

```{r fig.width=8, fig.height=7}
plotUMAP(sce_T, color_by = "contaminated_Tcell")
```

```{r}
plotColData(
  sce_T,
  y = "contamination",
  x = "IgG_logcounts",
  color_by = "contaminated_Tcell"
) +
  scale_x_continuous(
    breaks = c(0, 0.5, 1, 2, 4)) +
  geom_vline(xintercept = IGKC_logcount_thresh)
```

```{r}
plotColData(
  sce_T,
  y = "contamination",
  x = "IgG_counts",
  color_by = "contaminated_Tcell"
) +
  scale_x_continuous(
    trans = "pseudo_log",
    breaks = c(0, 1, 2, 10, 30))
```

```{r}
colData(sce_T) %>%
  as.data.frame() %>%
  group_by(Compartment, contaminated_Tcell) %>%
  reframe(cells = n()) %>%
  pivot_wider(
    names_from = contaminated_Tcell,
    values_from = cells,
    names_prefix = "contaminated_",
    values_fill = 0
  )
```

```{r, fig.height=6, fig.width=10}
cluster_cols <- grep("^clusters_res", colnames(sce_T@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_T[[cluster_col]] <- NULL
}

sce_T_clean <- sce_T[, !sce_T$contaminated_Tcell]

sce_T_clean <- process_sce(
  sce_T_clean,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.45, 0.5),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=9, fig.height=8}
plotUMAP(sce_T_clean, color_by = "CD3D") + labs(title = "CD3 Delta - T cells") +

plotUMAP(sce_T_clean, color_by = "CD8A") + labs(title = "CD8+ T cells") +

plotUMAP(sce_T_clean, color_by = "CD4") + labs(title = "CD4+ T cells") +

plotUMAP(sce_T_clean, color_by = "NCR1") + labs(title = "NCR1 - NK cells")
```

```{r, fig.width=10, fig.height=4.5}
plotUMAP(sce_T_clean, color_by = "IGKC") +
  plotUMAP(sce_T_clean, color_by = "IGHM")
```

```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce_T_clean@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_T_clean, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```


```{r, fig.width=11, fig.height=7}
sce_T_clean[["clusters"]] <- sce_T_clean[["clusters_res_0.3"]]
plotUMAP(
    sce_T_clean,
    color_by = "clusters",
    other_fields = "Compartment"
    ) +
  theme_bw() +
  facet_wrap(~ Compartment)
```

```{r, fig.width=12, fig.height=10}
plotUMAP(sce_T_clean, color_by = "Sample") +
  labs(title = "Sample") +
  
  plotUMAP(sce_T_clean, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  
  plotUMAP(sce_T_clean, color_by = "cell_type_main") +
  labs(title = "SingleR cell types") +
  
  plotUMAP(sce_T_clean, color_by = "tricyclePhase") +
  labs(title = "Cell cycle")
```

```{r}
cluster_abundance <- colData(sce_T_clean) %>%
  as.data.frame() %>% 
  count(Compartment, clusters) %>%
  group_by(clusters) %>%
  mutate(proportion = n / sum(n))

ggplot(cluster_abundance, aes(x = proportion, y = factor(clusters), fill = Compartment)) +
  geom_col() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "", y = "Clusters", title = "Cluster composition") +
  theme_minimal(base_size = 18) +
  theme(
    panel.grid = element_blank(),
    axis.ticks.y = element_blank()
  )
```

```{r}
cluster_abundance <- colData(sce_T_clean) %>%
  as.data.frame() %>% 
  count(Patient, clusters) %>%
  group_by(clusters) %>%
  mutate(proportion = n / sum(n))

ggplot(cluster_abundance, aes(x = proportion, y = factor(clusters), fill = Patient)) +
  geom_col() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "", y = "Clusters", title = "Cluster composition") +
  theme_minimal(base_size = 18) +
  theme(
    panel.grid = element_blank(),
    axis.ticks.y = element_blank()
  )
```

## Analyze markers

```{r, warning=FALSE}
rowData(sce_T_clean)[["Unique_Symbol"]] <- make.unique(rowData(sce_T_clean)[["Symbol"]])
rownames(sce_T_clean) <- rowData(sce_T_clean)[["Unique_Symbol"]]
seurat_T <- as.Seurat(sce_T_clean, counts = "counts", data = "logcounts")

Idents(seurat_T) <- seurat_T$clusters

T_cell_clusters = levels(seurat_T$clusters)
  
markers_list <- list()
for(cluster in T_cell_clusters){
  markers_list[[cluster]] <- FindMarkers(seurat_T, ident.1 = cluster,
                         test.use = "wilcox",
                         logfc.threshold = 0.5,
                         min.pct = 0.1,
                         only.pos = TRUE,
                         random.seed = seed
                         ) %>% 
    rank_genes_enhanced()
}
markers_list
```

```{r, warning=FALSE}
markers_text_list <- list()
for(cluster_n in names(markers_list)){
  markers_text <- filter(markers_list[[cluster_n]]) %>% 
    head(markers, n = 60) %>% 
    rownames() %>% 
    paste(collapse = ", ")
  markers_text <- paste0("Cluster ", cluster_n, ": ", markers_text)
  markers_text_list[[as.character(cluster_n)]] <- markers_text
}
text <- paste(markers_text_list, collapse = "\n\n")
cat(text)
```

```{r, fig.width=5, fig.height=10, message=FALSE}
marker_genes <- list(
  "T cells CD8+ Effector Memory" = c("CD8A", "CD8B", "GZMH", "CCL5", "NKG7", "KLRG1"),
  "CD4+ Naive/CM" = c("CD4", "IL7R", "CCR7", "LEF1", "TCF7", "LTB"),
  "NK cells" = c("NCR1", "FCGR3A", "KLRC1", "KLRC2", "KLRF1", "GNLY", "GZMB"),
  "Activated/ISG" = c("CD69", "FOS", "JUN", "ISG15", "MX1", "IFI44L", "DUSP1", "DUSP2"),
  "CD8+ TRM/Exhausted" = c("PDCD1", "LAG3", "HAVCR2", "CTLA4", "TIGIT", "ENTPD1", "CXCR6"),
  "γδ T cells" = c("TRGV5", "TRGC1", "TRGC2", "KLRB1", "IKZF2"),
  "CD8+ TEM" = c("ITGAM", "ITGB1", "TRBV14", "TRAV12-2"),
  "CD8+ Terminal Effector" = c("S100B", "PROK2", "PRSS23", "ADRB2", "PLEK", "GTSF1")
)
all_markers <- unique(unlist(marker_genes)) %>% rev()

plotDots(
  sce_T_clean,
  features = all_markers,
  scale = TRUE,
  center = TRUE,
  group = "clusters",
  zlim = c(-2.5, 2.5)
) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    name = "Average"
  ) +
  labs(x = "Cluster", y = NULL)
```

```{r}
cells_df <- colData(sce_T_clean) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters == 1 ~ "T cells CD8+ Effector Memory",
      clusters == 2 ~ "T cells CD4+",
      clusters == 3 ~ "NK cells",
      clusters == 4 ~ "T cells Activated",
      clusters == 5 ~ "T cells Exhausted",
      clusters == 6 ~ "T cells γδ",
      clusters == 7 ~ "T cells CD8+ Oligoclonal",
      clusters == 8 ~ "T cells CD8+ Effector Memory subset"
    )
  )

cluster_to_cells <- setNames(cells_df$cell_type, cells_df$clusters)
colData(sce_T_clean)$cell_type_manual <- cluster_to_cells[as.character(colData(sce_T_clean)$clusters)]

data.frame(
  cell_type_manual = sce_T_clean$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r fig.width=9, fig.height=7}
plotUMAP(sce_T_clean, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation")
```

```{r}
# Join annotations for clean T cells and contaminated
cell_type <- colData(sce_T_clean) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type" = "cell_type_manual")

sce_T$cell_type_manual <- colData(sce_T) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  left_join(
    ., cell_type, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type = case_when(
      contaminated_Tcell ~ "T cell (IgG contaminated)",
      TRUE ~ cell_type
    )
  ) %>% 
  pull(cell_type)
```


```{r}
# Join annotations for all T cells and total dataset
cell_type <- colData(sce_T) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type" = "cell_type_manual")

all_cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., cell_type, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type = case_when(
      is.na(cell_type) ~ cell_type_manual,
      TRUE ~ cell_type
    )
  )

sce$cell_type_manual <- all_cell_types$cell_type
```


```{r fig.width=9, fig.height=7}
plotUMAP(sce, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation")
```

# Re-cluster B and other normal cells

```{r, fig.height=6, fig.width=10}
sce_n <- sce[, sce$cell_type_manual %in% c("B cell", "Other")]

cluster_cols <- grep("^clusters_res", colnames(sce_n@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_n[[cluster_col]] <- NULL
}

sce_n <- process_sce(
  sce_n,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.45, 0.5),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=6, fig.height=5}
cluster_cols <- grep("^clusters_res", colnames(sce_n@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_n, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots
```

```{r, fig.width=11, fig.height=7}
sce_n[["clusters"]] <- sce_n[["clusters_res_0.3"]]
plotUMAP(
    sce_n,
    color_by = "clusters",
    other_fields = "Compartment"
    ) +
  theme_bw() +
  facet_wrap(~ Compartment)
```

```{r UMAPs_leukocytes, fig.width=10, fig.height=8}
plotUMAP(sce_n, color_by = "Sample") +
  labs(title = "Sample") +
  
  plotUMAP(sce_n, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  
  plotUMAP(sce_n, color_by = "cell_type_main") +
  labs(title = "SingleR cell types") +
  
  plotUMAP(sce_n, color_by = "tricyclePhase") +
  labs(title = "Cell cycle")
```

```{r, fig.width=15, fig.height=4.5}
plotUMAP(sce_n, color_by = "MS4A1") +
  plotUMAP(sce_n, color_by = "IGHM") +
  plotUMAP(sce_n, color_by = "CCND1")
```

```{r featureUMAP_leukocytes, fig.width=8, fig.height=4}
plotUMAP(sce_n, color_by = "FCGR3A") + labs(title = "CD16a - Monocytes") +
  plotUMAP(sce_n, color_by = "LYZ") + labs(title = "LYZ - Monocytes")
```

## Analyze markers

```{r, warning=FALSE}
rowData(sce_n)[["Unique_Symbol"]] <- make.unique(rowData(sce_n)[["Symbol"]])
rownames(sce_n) <- rowData(sce_n)[["Unique_Symbol"]]
seurat <- as.Seurat(sce_n, counts = "counts", data = "logcounts")

Idents(seurat) <- seurat$clusters

seurat_clusters = levels(seurat$clusters)
  
markers_list <- list()
for(cluster in seurat_clusters){
  markers_list[[cluster]] <- FindMarkers(seurat, ident.1 = cluster,
                         test.use = "wilcox",
                         logfc.threshold = 0.5,
                         min.pct = 0.1,
                         only.pos = TRUE,
                         random.seed = seed
                         ) %>% 
    rank_genes_enhanced()
}
markers_list
```

```{r, warning=FALSE}
markers_text_list <- list()
for(cluster_n in names(markers_list)){
  markers_text <- filter(markers_list[[cluster_n]]) %>% 
    head(markers, n = 60) %>% 
    rownames() %>% 
    paste(collapse = ", ")
  markers_text <- paste0("Cluster ", cluster_n, ": ", markers_text)
  markers_text_list[[as.character(cluster_n)]] <- markers_text
}
text <- paste(markers_text_list, collapse = "\n\n")
cat(text)
```

```{r}
cells_df <- colData(sce_n) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters == 1 ~ "B cells Naive/Mature",
      clusters == 2 ~ "B cells Memory",
      clusters == 3 ~ "Monocytes Classical",
      clusters == 4 ~ "Monocytes Non-classical",
      clusters == 5 ~ "B cells Progenitors/Pro-B",
      clusters == 6 ~ "B cells Activated",
      clusters == 7 ~ "MCL cell",
      clusters == 8 ~ "Erythroid progenitors",
      clusters == 9 ~ "Plasma cells",
    )
  )

cluster_to_cells <- setNames(cells_df$cell_type, cells_df$clusters)
colData(sce_n)$cell_type_manual <- cluster_to_cells[as.character(colData(sce_n)$clusters)]

data.frame(
  cell_type_manual = sce_n$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r}
# Join annotations for all T cells and total dataset
cell_type <- colData(sce_n) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type" = "cell_type_manual")

all_cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., cell_type, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type = case_when(
      is.na(cell_type) ~ cell_type_manual,
      TRUE ~ cell_type
    )
  )

sce$cell_type_manual <- all_cell_types$cell_type
```


```{r fig.width=9, fig.height=7}
plotUMAP(sce, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation")
```

# Marker dotplots

clusters == 7 ~ "T cells CD8+ Oligoclonal",
      clusters == 8 ~ "T cells CD8+ Effector Memory subset"

```{r, fig.width=5, fig.height=10, message=FALSE}
marker_genes <- list(
  "NK cells"                                  = c("NCR1", "FCGR3A", "KLRC1", "KLRC2", "GNLY", "GZMB"),
  "T cells CD8+ Effector Memory"              = c("CD8A", "CD8B", "GZMH", "CCL5", "NKG7", "KLRG1"),
  "T cells CD4+"                              = c("CD4", "IL7R", "CCR7", "LEF1", "TCF7", "LTB"),
  "T cells Activated"                         = c("CD69", "FOS", "JUN", "ISG15", "MX1", "IFI44L"),
  "T cells Exhausted"                         = c("PDCD1", "LAG3", "HAVCR2", "CTLA4", "TIGIT", "ENTPD1", "CXCR6"),
  "T cells γδ"                                = c("TRGV5", "TRGC1", "TRGC2", "KLRB1", "IKZF2"),
  "T cells CD8+ Oligoclonal"                  = c("ITGAM", "ITGB1", "TRBV14", "TRAV12-2"),
  "T cells CD8+ Effector Memory subset"       = c("S100B", "PROK2", "PRSS23", "ADRB2", "PLEK", "GTSF1")
)
all_markers <- unique(unlist(marker_genes)) %>% rev()

plotDots(
  sce[, sce$cell_type_manual %in% names(marker_genes)],
  features = all_markers,
  scale = TRUE,
  center = TRUE,
  group = "cell_type_manual",
  zlim = c(-2.5, 2.5)
) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    name = "Average"
  ) +
  labs(x = NULL, y = NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r, fig.width=5, fig.height=10, message=FALSE}
marker_genes <- list(
  "B cells Activated"         = c("AICDA", "RGS13", "CD79A", "BANK1", "TXNIP", "JUN"),
  "B cells Naive/Mature"      = c("MS4A1", "CD72", "BANK1", "FCMR", "IGHD", "CD37"),
  "B cells Memory"            = c("LTB", "CCR7", "SELL", "CXCR5", "CD40", "GPR183"),
  "B cells Progenitors/Pro-B" = c("RAG1", "RAG2", "VPREB1", "CD38", "IL7R", "TCL1A"),
  "Erythroid progenitors"     = c("GATA1", "HBA1", "GYPA", "ALAS2", "KLF1", "CD34"),
  "Monocytes Classical"       = c("CD14", "S100A8", "S100A9", "LYZ", "FCGR1A", "CCR2"),
  "Monocytes Non-classical"   = c("FCGR3A", "CX3CR1", "LST1", "CSF1R", "C1QA", "AIF1"),
  "Plasma cells"              = c("PRDM1", "XBP1", "JCHAIN", "SDC1", "TNFRSF17", "SLAMF7")
)
all_markers <- unique(unlist(marker_genes)) %>% rev()

plotDots(
  sce[, sce$cell_type_manual %in% names(marker_genes)],
  features = all_markers,
  scale = TRUE,
  center = TRUE,
  group = "cell_type_manual",
  zlim = c(-2.5, 2.5)
) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    name = "Average"
  ) +
  labs(x = NULL, y = NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Save results

```{r write_sce}
saveRDS(sce, path_sce_output)
```

# Session info

```{r sessionInfo}
print(sessionInfo())
```

```{r gc}
gc()
```
