---
title: "Cell type annotation"
params:
  seed: 42
  input_file: "../results/SCE/merged.sce"
  output_file: "annotated.sce"
  process_fun: "../bin/process_sce.R"
---

```{r setup}
seed <- params$seed
set.seed(seed)

# Load the libraries
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(Seurat)
  library(scater)
  library(scran)
  library(tricycle)
  library(SingleR)
  library(celldex)
  library(tidyverse)
  library(patchwork)
  library(ggridges)
})

path_sce_input <- params$input_file
path_sce_output <- params$output_file

process_fun <- params$process_fun
source(process_fun)

# Product-Based Ranking with Normalization 
rank_genes_enhanced <- function(markers) {
  # In case any p value is 0
  min_nonzero_p <- min(markers$p_val_adj[markers$p_val_adj > 0])
  markers$p_val_adj[markers$p_val_adj == 0] <- min_nonzero_p / 10
  
  # Normalize components to 0-1 scale
  norm_pval <- (-log10(markers$p_val_adj) - min(-log10(markers$p_val_adj))) /
    (max(-log10(markers$p_val_adj)) - min(-log10(markers$p_val_adj)))
  
  norm_fc <- (markers$avg_log2FC - min(markers$avg_log2FC)) /
    (max(markers$avg_log2FC) - min(markers$avg_log2FC))
  
  # Product-based score
  markers$rank_score <- norm_pval * norm_fc
  
  # Sort and return
  return(markers[order(markers$rank_score, decreasing = TRUE), ])
}
```

# Read the sce

```{r load_sce}
sce <- readRDS(path_sce_input)
sce
```

```{r}
colData(sce) %>% 
  as.data.frame() %>% 
  group_by(Sample) %>% 
  reframe(cells = n())
```

# Dataset QC

```{r, fig.width=10, fig.height=7}
plotColData(sce, y = "sum",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_blank()) +
  labs(y = "UMIs per cell, log10") + 
  
  plotColData(sce, y = "detected",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_blank()) +
  labs(y = "nGenes per cell, log10") +
  
  plotColData(sce, y = "subsets_Mito_percent",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  scale_y_continuous(limits = c(0, 30)) +
  theme(axis.text.x = element_blank()) +
  labs(y = "%Mito") +
  
  plotColData(sce, y = "Mito_Ribo_Ratio",
                    x = "Sample",
                    color_by = "Compartment"
                    ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "%Mito/%Ribo ratio") +
  
  plot_layout(ncol = 1)
```

# Process all cells

```{r process_sce}
sce <- process_sce(
  sce,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  seed = seed,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.5, 0.6),
  return_obj = "sce"
)
```

## Choose cluster resolution

```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots[["clusters_res_0.3"]]

sce[["clusters"]] <- sce[["clusters_res_0.3"]]
```

```{r, fig.width=10, fig.height=5}
plotUMAP(sce,
         color_by = "MS4A1") +
  plotUMAP(sce,
         color_by = "CCND1")
```

# Inspect cells by sample

```{r, fig.width=6, fig.height=5}
plotUMAP(sce,
         color_by = "Sample")
```

```{r, fig.width=10.5, fig.height=5}
plotUMAP(sce,
         color_by = "Patient",
         other_fields = "Timepoint") +
  facet_wrap(~ Timepoint) +
  theme_bw()
```

```{r, fig.width=10, fig.height=10}
plotUMAP(sce,
         color_by = "Sample", other_fields = "Sample") +
  facet_wrap(
    ~ Sample
  )
```

```{r, fig.width=10, fig.height=10}
plotUMAP(sce,
         color_by = "IGKC", other_fields = "Sample") +
  facet_wrap(
    ~ Sample
  )
```

## Cell cycle scoring

If cell cycle effects are not addressed, later when annotating the normal cells, cycling T cells would form a cluster.
Tested that even if they are regressed the cluster still forms.

```{r project_cycle_space, fig.width=7, fig.height=5}
sce <- project_cycle_space(sce,
                           species = "human",
                           gname.type = "SYMBOL")

center_PCs <- c(-3, 0.4)

sce <- estimate_cycle_position(sce,
                               center.pc1 = center_PCs[1],
                               center.pc2 = center_PCs[2])

p <- plot_emb_circle_scale(sce,
                           dimred = "tricycleEmbedding",
                           point.size = 3.5,
                           point.alpha = 0.9) +
  annotate(
    "point",
    x = center_PCs[1],
    y = center_PCs[2],
    size = 4,
    color = "red",
    shape = 8,
    stroke = 1
  ) +
  labs(title = NULL) +
  theme_bw(base_size = 14)
legend <- circle_scale_legend(text.size = 4.5, alpha = 0.9)
cowplot::plot_grid(p, legend, ncol = 2, rel_widths = c(1, 0.4))
```

```{r tricycle_phases, fig.width=6, fig.height=5}
phases = c(
  "G1" = 0.2 * pi,
  "S" = 0.8 * pi,
  "G2.M" = 1 * pi,
  "G0" = 1.8 * pi
)

# Map position to phase
TCP.df <- data.frame(colname = colnames(sce),
                     TCP = sce$tricyclePosition,
                     Phase = NA
                     )
for(position in names(phases)){
  TCP.df[TCP.df$TCP > phases[[position]] ,]$Phase <- position
}
TCP.df[is.na(TCP.df$Phase), ]$Phase <- "G0"
TCP.df$Phase <- factor(TCP.df$Phase,
                       levels = c("G0", "G1", "S", "G2.M") )

sce$tricyclePhase <- TCP.df$Phase

ggcells(sce,
        mapping = aes(x = tricycleEmbedding.1,
                      y = tricycleEmbedding.2
                      )
        ) +
  geom_point(
    aes(color = tricyclePhase)
  ) +
  geom_density2d(
    data = as.data.frame(reducedDims(sce)[["tricycleEmbedding"]]),
    aes(x = PC1, y = PC2), adjust = 2,
    color = "black"
  ) +
  annotate("point",
           x = center_PCs[1],
           y = center_PCs[2],
           size = 4,
           color = "black", shape = 4,
           stroke = 1
           )
```

```{r, fig.width=6, fig.height=5}
plotUMAP(sce,
         color_by = "tricyclePhase")
```

## Automatic cell types

```{r cache_reference}
gypsum::cacheDirectory("./gypsum_cache")
ref <- celldex::MonacoImmuneData()
ref
```

```{r reference_based_annotation, warning=FALSE, fig.width=6, fig.height=5}
predicted.types.main <- SingleR(
  test = sce,
  ref = ref,
  labels = ref$label.main,
  de.method = "classic"
)

# assign cell types to sce
sce$cell_type_main <- predicted.types.main$labels

colData(sce) %>% 
  as.data.frame() %>% 
  group_by(cell_type_main) %>% 
  reframe(N = n()) %>% 
  arrange(desc(N))
```

```{r, fig.width=8, fig.height=7}
plotUMAP(sce,
         color_by = "cell_type_main") +
  labs(title = "Cell types")
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce,
         color_by = "cell_type_main",
         other_fields = c("Patient", "Timepoint")) +
  facet_grid(Timepoint ~ Patient) +
  theme_bw() +
  labs(title = "Cell types")
```

## B cell clusters

```{r, fig.width=10, fig.height=9}
plotUMAP(sce, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  plotUMAP(sce, color_by = "cell_type_main") +
  labs(title = "Cell types") +
  plotUMAP(sce, color_by = "MS4A1") +
  labs(title = "CD20 - B cells") +
  plotUMAP(sce, color_by = "CD3E") +
  labs(title = "CD3 epsilon - T cells")
```

```{r, fig.width=5.5, fig.height=5}
plotUMAP(sce, color_by = "CCND1") +
  labs(title = "Cyclin D1")
```


## Label cell clusters

```{r}
cell_type_df <- colData(sce) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters %in% c(2, 9, 12, 13) ~ "NK/T cell",
      clusters %in% c(15, 16) ~ "Other",
      TRUE ~ "B cell",
    )
  )

cluster_to_celltype <- setNames(cell_type_df$cell_type, cell_type_df$clusters)
sce$cell_type_manual <- cluster_to_celltype[as.character(colData(sce)$clusters)]

data.frame(
  cell_type_manual = sce$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r, fig.width=5.5, fig.height=5}
plotUMAP(sce, color_by = "cell_type_manual",) +
  labs(title = "Manual annotation 1")
```

# Re-cluster B cells

```{r process_sce_B_cells, fig.height=6, fig.width=10}
sce_B <- sce[, sce$cell_type_manual == "B cell"]

cluster_cols <- grep("^clusters_res", colnames(sce_B@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_B[[cluster_col]] <- NULL
}

sce_B <- process_sce(
  sce_B,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.5, 0.6),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B, color_by = "Sample") +
  theme(legend.position = "bottom") +

plotUMAP(sce_B, color_by = "CCND1") +
  theme(legend.position = "bottom") +
  labs(title = "Cyclin D1") +
  
  plotUMAP(sce_B, color_by = "tricyclePhase") +
  theme(legend.position = "bottom")
```


```{r, fig.width=8, fig.height=7}
cluster_cols <- grep("^clusters_res", colnames(sce_B@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_B, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots[["clusters_res_0.2"]]

sce_B[["clusters"]] <- sce_B[["clusters_res_0.2"]]
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B, color_by = "Sample") +
  theme(legend.position = "bottom") +
  labs(title = "Sample") +
  plotUMAP(sce_B, color_by = "clusters", text_by = "clusters") +
  theme(legend.position = "bottom") +
  labs(title = "Clusters") +
  plotUMAP(sce_B, color_by = "CCND1") +
  theme(legend.position = "bottom") +
  labs(title = "Cyclin D1")
```

```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B, color_by = "IGLC1") +
  theme(legend.position = "bottom") +
  
  plotUMAP(sce_B, color_by = "IGLC2") +
  theme(legend.position = "bottom") +
  
  plotUMAP(sce_B, color_by = "IGKC") +
  theme(legend.position = "bottom")
```


```{r, fig.width=15, fig.height=6}
plotUMAP(sce_B,
         color_by = "clusters",
         other_fields = c("Patient", "Timepoint")) +
  facet_grid(Timepoint ~ Patient) +
  theme_bw()
```

```{r}
B_cells_df <- colData(sce_B) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters %in% c(3, 11) ~ "B cell",
      TRUE ~ "MCL cell"
    )
  )

cluster_to_Bcell <- setNames(B_cells_df$cell_type, B_cells_df$clusters)
colData(sce_B)$cell_type_manual <- cluster_to_Bcell[as.character(colData(sce_B)$clusters)]

data.frame(
  cell_type_manual = sce_B$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r, fig.width=6, fig.height=5}
plotUMAP(sce_B, color_by = "cell_type_manual",) +
  labs(title = "Annotation for B cells") +
  theme_void(base_size = 14)
```

## Inspect CCND1 threshold

```{r, fig.height=4, fig.width=5}
cell.types <- c("MCL cell", "B cell")

CCND1_logcount_threshold <- 0.5

cell.types <- c("B cell", "MCL cell")

CCND1_logcount_threshold <- 0.25

data.frame(
  Patient = sce_B$Patient,
  Cell_type = sce_B$cell_type_manual,
  "logcounts.CCND1" = logcounts(sce_B)["CCND1", ]
) %>%
  mutate(Cell_type = factor(Cell_type, levels = cell.types)) %>%
  ggplot() +
  geom_histogram(
    aes(x = logcounts.CCND1, fill = Cell_type),
    bins = 50
    ) +
  geom_vline(xintercept = CCND1_logcount_threshold,
             color = "grey10", linetype = "dashed"
             ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  facet_wrap(~ Cell_type, ncol = 1) +
  labs(y = "Cells", x = "log(counts) CCND1") +
  theme_bw() +
  theme(legend.position = "none")
```

This shows why just setting an expression threshold does not work:

```{r fig.width=6, fig.height=5}
sce_B$CCND1_status <- ifelse(logcounts(sce_B)["CCND1", ] > CCND1_logcount_threshold,
                                    "CCND1_high",
                                    "CCND1_low")
sce_B$CCND1_status <- factor(sce_B$CCND1_status, levels = c("CCND1_low", "CCND1_high"))
plotUMAP(sce_B, color_by = "CCND1_status") +
  theme_void(base_size = 14)
```

```{r fig.height=4, fig.width=5}
data.frame(
  Patient = sce_B$Patient,
  CCND1_status = sce_B$CCND1_status,
  "logcounts.CCND1" = logcounts(sce_B)["CCND1", ]
) %>%
  mutate(Cell_type = factor(CCND1_status, levels = c("CCND1_low", "CCND1_high"))) %>%
  ggplot() +
  geom_histogram(
    aes(x = logcounts.CCND1, fill = Cell_type),
    bins = 50
    ) +
  geom_vline(xintercept = CCND1_logcount_threshold,
             color = "grey10", linetype = "dashed"
             ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  facet_wrap(~ Cell_type, ncol = 1) +
  labs(y = "Cells", x = "log(counts) CCND1") +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
Bcell_types <- colData(sce_B) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "Bcell_type" = "cell_type_manual")

cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., Bcell_types, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type_manual = case_when(
      cell_type_manual == "B cell" ~ Bcell_type,
      TRUE ~ cell_type_manual
    )
  )

sce$cell_type_manual <- cell_types$cell_type_manual
```

```{r fig.width=8, fig.height=7}
plotUMAP(sce, color_by = "cell_type_manual") +
  labs(title = "Manual annotation 2")
```

# Refine normal B cells and other cells

```{r, fig.height=6, fig.width=10}
sce_n <- sce[, sce$cell_type_manual %in% c("B cell", "Other")]

cluster_cols <- grep("^clusters_res", colnames(sce_n@colData), value = TRUE)
for (cluster_col in cluster_cols) {
  sce_n[[cluster_col]] <- NULL
}

sce_n <- process_sce(
  sce_n,
  HVF_method = "scran_mgv",
  HVG_fdr_threshold = 0.2,
  pca_variance_threshold = 1.5,
  FindClusters_res = c(0.1, 0.2, 0.3, 0.35, 0.4, 0.45, 0.5),
  seed = seed,
  return_obj = "sce"
)
```

```{r, fig.width=6, fig.height=5}
cluster_cols <- grep("^clusters_res", colnames(sce_n@colData), value = TRUE)

cluster_plots <- list()
for (cluster_col in cluster_cols) {
  cluster_plots[[cluster_col]] <- plotUMAP(sce_n, color_by = cluster_col, text_by = cluster_col) +
    labs(title = cluster_col)
}
cluster_plots[["clusters_res_0.3"]]

sce_n[["clusters"]] <- sce_n[["clusters_res_0.3"]]
```

```{r, fig.width=11, fig.height=7}
plotUMAP(
    sce_n,
    color_by = "clusters",
    other_fields = "Compartment"
    ) +
  theme_bw() +
  facet_wrap(~ Compartment)
```

```{r UMAPs_leukocytes, fig.width=10, fig.height=8}
plotUMAP(sce_n, color_by = "Sample") +
  labs(title = "Sample") +
  
  plotUMAP(sce_n, color_by = "clusters", text_by = "clusters") +
  labs(title = "Clusters") +
  
  plotUMAP(sce_n, color_by = "cell_type_main") +
  labs(title = "SingleR cell types") +
  
  plotUMAP(sce_n, color_by = "tricyclePhase") +
  labs(title = "Cell cycle")
```

```{r, fig.width=15, fig.height=4.5}
plotUMAP(sce_n, color_by = "MS4A1") +
  plotUMAP(sce_n, color_by = "IGHM") +
  plotUMAP(sce_n, color_by = "CCND1")
```

```{r featureUMAP_leukocytes, fig.width=8, fig.height=4}
plotUMAP(sce_n, color_by = "CD14") + labs(title = "CD14 - Monocytes Classical") +
  plotUMAP(sce_n, color_by = "FCGR3A") + labs(title = "CD16a - Monocytes Non-classical")
```

```{r, fig.width=10, fig.height=7}
plotUMAP(sce_n, color_by = "C1QA", other_fields = "Compartment") +
  facet_wrap(~ Compartment) +
  theme_bw() +
  labs(title = "C1QA - Tissue macrophages") 
```

```{r, fig.width = 8, fig.height=7}
plotUMAP(sce_n, color_by = "CD1C") + 
  labs(title = "Dendritic cells") +
  plotUMAP(sce_n, color_by = "LAMP3") +
  plotUMAP(sce_n, color_by = "CLEC9A") +
  plotUMAP(sce_n, color_by = "CLEC10A")
```

```{r, fig.width=6, fig.height=10, message=FALSE}
marker_genes <- list(
  "B cells Naive/Mature"      = c("IGHD", "MS4A1", "CD72", "FCMR", "CD37", "BANK1"),
  "B cells Memory"            = c("LTB", "CCR7", "CXCR5", "CD40", "GPR183", "SELL"),
  "Monocytes Classical"       = c("CD14", "S100A8", "S100A9", "LYZ", "FCGR1A", "CCR2", "FCN1"),
  "Monocytes Non-classical"   = c("FCGR3A", "CX3CR1", "LST1", "CSF1R", "C1QA", "AIF1"),
  "Dendritic cells"           = c("CD1C", "LAMP3", "CLEC10A"),
  "B cells Progenitors/Pro-B" = c("RAG1", "RAG2", "VPREB1", "IL7R", "TCL1A", "CD38"),
  "B cells Activated"         = c("AICDA", "RGS13", "CD79A", "BANK1", "TXNIP"),
  "MCL cell"                  = c("CCND1"),
  "Erythroid progenitors"     = c("GATA1", "HBA1", "GYPA", "ALAS2", "KLF1", "CD34"),
  "Plasma cells"              = c("PRDM1", "XBP1", "JCHAIN", "SDC1", "TNFRSF17", "SLAMF7")
)
all_markers <- unique(unlist(marker_genes)) %>% rev()

plotDots(
  sce_n,
  features = all_markers,
  scale = TRUE,
  center = TRUE,
  group = "clusters",
  zlim = c(-2.5, 2.5)
) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    name = "Average"
  ) +
  labs(x = NULL, y = NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
cells_df <- colData(sce_n) %>% 
  as.data.frame() %>% 
  remove_rownames() %>% 
  select(clusters) %>% 
  distinct() %>% 
  arrange(clusters) %>% 
  mutate(
    cell_type_manual = case_when(
      clusters == 1 ~ "B cells Naive/Mature",
      clusters == 2 ~ "B cells Memory",
      clusters == 3 ~ "Monocytes Classical/Dendritic cells",
      clusters == 4 ~ "Monocytes Non-classical",
      clusters == 5 ~ "B cells Progenitors/Pro-B",
      clusters == 6 ~ "B cells Activated",
      clusters == 7 ~ "MCL cell",
      clusters == 8 ~ "Erythroid progenitors",
      clusters == 9 ~ "Plasma cells",
    )
  )

cluster_to_cells <- setNames(cells_df$cell_type, cells_df$clusters)
colData(sce_n)$cell_type_manual <- cluster_to_cells[as.character(colData(sce_n)$clusters)]

data.frame(
  cell_type_manual = sce_n$cell_type_manual
) %>% 
  group_by(cell_type_manual) %>% 
  reframe(N = n())
```

```{r}
# Join annotations for all T cells and total dataset
cell_type <- colData(sce_n) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type" = "cell_type_manual")

all_cell_types <- colData(sce) %>% 
  as.data.frame() %>% 
  rownames_to_column("Barcode_Sample") %>% 
  dplyr::select("Barcode_Sample", "cell_type_manual") %>% 
  left_join(
    ., cell_type, by = "Barcode_Sample"
  ) %>% 
  mutate(
    cell_type = case_when(
      is.na(cell_type) ~ cell_type_manual,
      TRUE ~ cell_type
    )
  )

sce$cell_type_manual <- all_cell_types$cell_type
```

```{r}
main_cell_types <- c(
  "NK/T cell",
  "B cells Naive/Mature",
  "B cells Activated",
  "B cells Progenitors/Pro-B",
  "Plasma cells",
  "B cells Memory",
  "Monocytes Classical/Dendritic cells",
  "Monocytes Non-classical",
  "Erythroid progenitors",
  "MCL cell"
  )             
sce$cell_type_manual <- factor(sce$cell_type_manual, levels = main_cell_types)
```

```{r fig.width=8, fig.height=5}
plotUMAP(sce, color_by = "cell_type_manual",) +
  guides(color = guide_legend(override.aes = list(size = 3), title = "Cell type")) +
  theme_void(base_size = 14)
```

# Final marker dotplot

```{r, fig.width=6, fig.height=8, message=FALSE}
marker_genes <- list(
  "NK cells"                  = c("NCR1", "GNLY", "GZMB"),
  "T cells"                   = c("CD3E", "CD8A", "CD8B", "IL7R"),
  "B cells Naive/Mature"      = c("IGHD", "MS4A1", "CD72"),
  "B cells Activated"         = c("CD79A", "AICDA", "RGS13"),
  "B cells Progenitors/Pro-B" = c("RAG1", "RAG2", "VPREB1", "CD38"),
  "Plasma cells"              = c("PRDM1", "XBP1", "JCHAIN"),
  "B cells Memory"            = c("LTB", "CD40", "GPR183"),
  "Dendritic cells"           = c("LAMP3", "CLEC10A"),
  "Monocytes Classical"       = c("CD14", "FCGR1A", "CCR2", "FCN1"),
  "Monocytes Non-classical"   = c("FCGR3A", "CX3CR1", "CSF1R", "C1QA"),
  "Erythroid progenitors"     = c("GATA1", "HBA1", "KLF1", "CD34"),
  "MCL cell"                  = c("CCND1")
)
all_markers <- unique(unlist(marker_genes)) %>% rev()

plotDots(
  sce,
  features = all_markers,
  scale = TRUE,
  center = TRUE,
  group = "cell_type_manual",
  zlim = c(-2.5, 2.5)
) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    name = "Average"
  ) +
  labs(x = NULL, y = NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Save results

```{r write_sce}
saveRDS(sce, path_sce_output)
```

# Session info

```{r sessionInfo}
print(sessionInfo())
```

```{r gc}
gc()
```
